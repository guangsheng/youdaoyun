### 介绍
+ iptables的前身叫ipfirewall,ipchains  
+ 内核空间当中的netfilter(网络过滤器)来读取iptables定义的规则
+ 五个位置
    - 内核空间中：从一个网络接口进来，到另一个网络接口去的
    - 数据包从内核流入用户空间的
    - 数据包从用户空间流出的
    - 进入/离开本机的外网接口
    - 进入/离开本机的内网接口

### 工作机制，规则链
+ PREROUTING (路由前)
+ INPUT (数据包流入口)
+ FORWARD (转发管卡)
+ OUTPUT(数据包出口)
+ POSTROUTING（路由后）

### 防火墙策略
+ filter： 定义允许或者不允许的策略，只能做在3个链上：INPUT ，FORWARD ，OUTPUT
+ NAT: 定义地址转换选项，只能做在3个链上：PREROUTING ，OUTPUT ，POSTROUTING
+ mangle：修改报文原数据，5个链都可以做：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING

**规则的次序非常关键，谁的规则越严格，应该放的越靠前，而检查规则的时候，是按照从上往下的方式进行检查的。**

### 命令使用
格式：```iptables [-t table] COMMAND chain CRETIRIA -j ACTION```  
+ -t table ：3个filter nat mangle
+ COMMAND：定义如何对规则进行管理
+ chain：指定你接下来的规则到底是在哪个链上操作的，当定义策略的时候，是可以省略的
+ CRETIRIA:指定匹配标准
+ -j ACTION :指定如何进行处理

#### 命令永久生效
注意：你所定义的所有内容，当你重启的时候都会失效，要想我们能够生效，需要使用一个命令将它保存起来  
+ ```service iptables save```命令
它会保存在/etc/sysconfig/iptables这个文件中
+ iptables-save 命令
```iptables-save > /etc/sysconfig/iptables```
3.iptables-restore 命令
开机的时候，它会自动加载/etc/sysconfig/iptabels,如果开机不能加载或者没有加载，而你想让一个自己写的配置文件（假设为iptables.2）手动生效的话：  
```iptables-restore < /etc/sysconfig/iptables.2```

### 命令详解
#### -j Action说明
+ DROP：悄悄丢弃
+ REJECT：明示拒绝
+ ACCEPT：接受
+ custom_chain：转向一个自定义的链
+ MASQUERADE：源地址伪装
+ REDIRECT：重定向：主要用于实现端口重定向
+ MARK：打防火墙标记的
+ RETURN：返回,在自定义链执行完毕后使用返回，来返回原规则链。
#### 链管理
+ -P : 设置默认策略 ```iptables -P INPUT ACCEPT```
+ -F : 清空规则链
+ -N : 支持用户新建一个链
+ -X : 删除用户自定义的一个空链
+ -Z : 清空链及链中默认规则的计数器

#### 规则管理
+ -A：追加，在当前链的最后新增一个规则
+ -I num : 插入，把当前规则插入为第几条。
+ -R num：Replays替换/修改第几条规则
+ -D num：删除，明确指定删除第几条规则

#### 查看管理命令 “-L”
+ -n：以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名。
+ -v：显示详细信息
+ -vvv :越多越详细
+ -x：在计数器上显示精确值，不做单位换算
+ --line-numbers : 显示规则的行号
+ -t nat：显示所有的关卡的信息

#### 匹配说明
+ -s：指定作为源地址匹配，这里不能指定主机名称，必须是IP	IP | IP/MASK | 0.0.0.0/0.0.0.0,	而且地址可以取反，加一个“!”表示除了哪个IP之外
+ -d：表示匹配目标地址
+ -p：用于匹配协议的（这里的协议通常有3种，TCP/UDP/ICMP）
+ -i eth0：从这块网卡流入的数据(流入一般用在INPUT和PREROUTING上)
+ -o eth0：从这块网卡流出的数据9流出一般在OUTPUT和POSTROUTING上)
+ 扩展匹配
```
-p tcp :TCP协议的扩展。一般有三种扩展
--dport XX-XX：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如
--dport 21  或者 --dport 21-23 (此时表示21,22,23)
--sport：指定源端口
--tcp-fiags：TCP的标志位（SYN,ACK，FIN,PSH，RST,URG）
	对于它，一般要跟两个参数：
	1.检查的标志位
	2.必须为1的标志位
	--tcpflags syn,ack,fin,rst syn   =    --syn
	表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的SYN为1的包，还有一种简写方式，叫做--syn
-p udp：UDP协议的扩展
	--dport
	--sport
-p icmp：icmp数据报文的扩展
	--icmp-type：
	echo-request(请求回显)，一般用8 来表示
	所以 --icmp-type 8 匹配请求回显数据包
	echo-reply （响应的数据包）一般用0来表示
```

### NAT（Network Address Translation，网络地址转换）
#### SNAT基于原地址的转换
将我们内网的地址转换为一个外网的IP，我们就可以实现连接其他外网IP的功能。  

比如我们现在要将所有192.168.10.0网段的IP在经过的时候全都转换成172.16.100.1这个假设出来的外网地址：  
```iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.16.100.1```
这样，只要是来自本地网络的试图通过网卡访问网络的，都会被统统转换成172.16.100.1这个IP.  

那么，如果172.16.100.1不是固定的怎么办？  
我们都知道当我们使用联通或者电信上网的时候，一般它都会在每次你开机的时候随机生成一个外网的IP，意思就是外网地址是动态变换的。这时我们就要将外网地址换成 MASQUERADE(动态伪装):它可以实现自动寻找到外网地址，而自动将其改为正确的外网地址。所以，我们就需要这样设置：  
```iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j MASQUERADE```  
这里要注意：地址伪装并不适用于所有的地方。

#### DNAT目标地址转换
对于目标地址转换，数据流向是从外向内的，外面的是客户端，里面的是服务器端通过目标地址转换，我们可以让外面的ip通过我们对外的外网ip来访问我们服务器不同的服务器，而我们的服务却放在内网服务器的不同的服务器上。  

如何做目标地址转换呢？：  
```iptables -t nat -A PREROUTING -d 192.168.10.18 -p tcp --dport 80 -j DNAT --todestination 172.16.100.2```   
目标地址转换要做在到达网卡之前进行转换,所以要做在PREROUTING这个位置上