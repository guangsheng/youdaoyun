##### pip  - A tool for installing and managing Python packages

##### 知识点
1. docopt库使用
2. request库使用
3. prettytable库使用

##### 安装第三方库
```
pip install docopt
pip install requests
pip install prettytable
pip install urllib3
```

##### docopt库使用
```
#coding=utf-8
"""
Usage: 
test [-gdtkz] <from> <to> <date>

Options: -h,--help 显示帮助菜单 -g 高铁 -d 动车 -t 特快 -k 快速 -z 直达
Example: tickets -gdt beijing shanghai 2016-08-25
"""

from docopt import docopt

if __name__ == '__main__':
    arguments = docopt(__doc__)
    print(arguments)

```

###### 测试结果
```
root@ubuntu:/opt/code/python/querytrain# python test.py -dk shanghai hangzhou 20161010
{'-d': True,
 '-g': False,
 '-k': True,
 '-t': False,
 '-z': False,
 '<date>': '20161010',
 '<from>': 'shanghai',
 '<to>': 'hangzhou'}
```

##### 获取站点信息 parse_stations.py
```
#coding=utf-8

import requests 
import re 
import urllib3
import collections
import logging

def invert_dict(d):  
    return dict((v,k) for k,v in d.iteritems()) 

def get_stations():
    # 7@cqn|重庆南|CRW|chongqingnan|cqn|
    url = 'https://kyfw.12306.cn/otn/resources/js/framework/station_name.js?station_version=1.8968'
    urllib3.disable_warnings()
    r = requests.get(url,verify=False)
    #print(r.text)
    patter = re.compile('([A-Z]+)\|([a-z]+)')
    items = dict(re.findall(patter,r.text))
    #print(items)
    print("stations = {")
    itemstmp = invert_dict(items) 
    for key in sorted(itemstmp.keys()): 
        print("'{0}': '{1}',".format(key,itemstmp[key]))   
    print("}")

if __name__ == '__main__':
    logging.captureWarnings(True)
    get_stations()
```

python parse_stations.py > stations.py 

执行后需要修改下stations.py，把倒数第二行的,删掉

##### 获取列车信息类 myprettytable.py
```
#coding=utf-8

from prettytable import PrettyTable 

""" 解析列车信息 """ 
class TrainCollection(object):
    # 显示车次、出发/到达站、 出发/到达时间、历时、一等坐、二等坐、软卧、硬卧、硬座 
    header = '序号 车次 出发站/到达站 出发时间/到达时间 历时 商务座 一等座 二等座 软卧 硬卧 硬座 无座'.split() 

    def __init__(self,rows,traintypes): 
        self.rows = rows 
        self.traintypes = traintypes 

    """ 获取车次运行的时间 """
    def _get_duration(self,row):
        duration = row.get('lishi').replace(':','h') + 'm' 
        #duration = row.get('lishi')
        if duration.startswith('00'): 
            return duration[4:] 
        elif duration.startswith('0'): 
            return duration[1:] 
        return duration 

    def trains(self): 
        flag = 0 
        result = []
        for row in self.rows: 
            if row['station_train_code'][0] in self.traintypes: 
	        flag += 1
                # 序号 # 车次 # 出发、到达站点 # 成功、到达时间 # duration 时间 # 商务座 # 一等座 # 二等座 # 软卧 # 硬卧 # 硬座 # 无座 
                train = [ flag, row['station_train_code'], '/'.join([row['from_station_name'],row['to_station_name']]), '/'.join([row['start_time'],row['arrive_time']]), self._get_duration(row),row['swz_num'], row['zy_num'], row['ze_num'], row['rw_num'], row['yw_num'], row['yz_num'], row['wz_num'] ]
                result.append(train)
        return result

    """打印列车信息""" 
    def print_pretty(self):
        pt = PrettyTable() 
        pt._set_field_names(self.header) 
        for train in self.trains(): 
            pt.add_row(train) 
    	print(pt)

if __name__ == '__main__': 
    t = TrainCollection

```

##### 执行类 tickets.py
```
#coding=utf-8

""" Train tickets query via command-line. 

Usage: 
tickets [-gdtkz] <from> <to> <date> 

Options: -h,--help 显示帮助菜单 -g 高铁 -d 动车-t 特快-k 快速-z 直达
Example: tickets -gdt beijing shanghai 2016-08-25
"""

import logging
import requests
from docopt import docopt
from stations import stations
from myprettytable import TrainCollection

class SelectTrain(object):

    """获取命令行输入的参数"""
    def __init__(self):
        self.args = docopt(__doc__) #这个是获取命令行的所有参数，返回的是一个字典

    """command-line interface"""
    def cli(self):
        # 获取 出发站点和目标站点
        from_station = stations.get(self.args['<from>']) #出发站点
        to_station = stations.get(self.args['<to>']) # 目的站点
        leave_time = self._get_leave_time() # 出发时间
        # 拼接请求列车信息的Url
        url = 'https://kyfw.12306.cn/otn/lcxxcx/query?purpose_codes=ADULT&queryDate={0}&from_station={1}&to_station={2}'.format(leave_time,from_station,to_station)
        # 获取列车查询结果
        r = requests.get(url,verify=False)
        traindatas = r.json()['data']['datas'] # 返回的结果，转化成json格式，取出datas，方便后面解析列车信息用

        # 解析列车信息
        traintypes = self._get_traintype()
        views = TrainCollection(traindatas,traintypes)
        views.print_pretty()

    """
    获取列车型号，这个函数的作用是的目的是：当你输入 -g 是只是返回 高铁，输入 -gd 返回动车和高铁，当不输参数时，返回所有的列车信息
    """ 
    def _get_traintype(self):
        traintypes = ['-g','-d','-t','-k','-z']
        #trains = []
        #for traintype in traintypes:
        #    if self.args[traintype]:
        #        print(traintype)
        #        trains.append(traintype[-1].upper())
        trains = [traintype[-1].upper() for traintype in traintypes if self.args[traintype]]
        if trains:
            return trains
        else:
            return ['G','D','T','K','Z']
        #return ['G','D','T','K','Z']    
    
    """
    获取出发时间，这个函数的作用是为了：时间可以输入两种格式：2016-10-05、20161005
    """
    def _get_leave_time(self):
        leave_time = self.args['<date>']
        if len(leave_time) == 8:
            return '{0}-{1}-{2}'.format(leave_time[:4],leave_time[4:6],leave_time[6:])
        if '-' in leave_time:
            return leave_time
    
if __name__ == '__main__':
    logging.captureWarnings(True)
    cli = SelectTrain()
    cli.cli()

```
