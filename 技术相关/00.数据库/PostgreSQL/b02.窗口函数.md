#### 语法
+ 聚合函数 over()
+ 聚合函数 over(partition by 字段）：OVER子句内的PARTITION BY列表指定将行划分成组或分区， **组或分区共享相同的PARTITION BY表达式的值**。 对于每一行，窗口函数在和当前行落在同一个分区的所有行上进行计算。
+ 聚合函数 over(order by 字段)：控制行的顺序。 计算从前面到当前分区的值

>
1. OVER子句使在其之前的那个函数被视为一个窗口函数并在一组合适的行上执行计算
2. 在SQL处理中，窗口函数都是最后一步执行，而且仅位于Order by字句之前


#### 第一个例子
```
postgres=# select count(*) from pg_class;
 count
-------
   314
(1 row)

postgres=# select relname, relkind,  count(*) over() from pg_class limit 10;
          relname          | relkind | count
---------------------------+---------+-------
 pg_database_datname_index | i       |   314
 pg_database_oid_index     | i       |   314
 intbl                     | r       |   314
 idx_intbl                 | i       |   314
 out                       | r       |   314
 pg_statistic              | r       |   314
 pg_type                   | r       |   314
 pg_toast_2604             | t       |   314
 pg_toast_2604_index       | i       |   314
 pg_toast_2606             | t       |   314
(10 rows)

postgres=# select relkind, count(*) from pg_class group by relkind;
 relkind | count
---------+-------
 i       |   121
 r       |    63
 v       |   112
 t       |    18
(4 rows)

postgres=# select relname, relkind,  count(*) over(partition by relkind) from pg_class limit 5;
          relname           | relkind | count
----------------------------+---------+-------
 pg_shseclabel_object_index | i       |   121
 pg_extension_oid_index     | i       |   121
 pg_extension_name_index    | i       |   121
 pg_range_rngtypid_index    | i       |   121
 pg_policy_oid_index        | i       |   121
(5 rows)

```

#### 除普通聚合函数外，PG还提供了另外一些窗口函数
https://www.postgresql.org/docs/9.6/static/functions-window.html

#### 几个复杂的例子
```
postgres=# select relnamespace, count(*) from pg_class group by relnamespace;
 relnamespace | count
--------------+-------
           11 |   208
         2200 |     3
           99 |    36
        12349 |    67
(4 rows)

postgres=# select relname, relkind,  count(*) over(partition by relkind) as kind_cnt, relnamespace, count(*) over(partition by relnamespace) as namespace_kind from pg_class limit 10;
         relname         | relkind | kind_cnt | relnamespace | namespace_kind
-------------------------+---------+----------+--------------+----------------
 pg_operator_oid_index   | i       |      121 |           11 |            208
 pg_extension_oid_index  | i       |      121 |           11 |            208
 pg_extension_name_index | i       |      121 |           11 |            208
 pg_range_rngtypid_index | i       |      121 |           11 |            208
 pg_policy_oid_index     | i       |      121 |           11 |            208
 pg_trigger              | r       |       63 |           11 |            208
 pg_statistic            | r       |       63 |           11 |            208
 pg_type                 | r       |       63 |           11 |            208
 pg_authid               | r       |       63 |           11 |            208
 pg_user_mapping         | r       |       63 |           11 |            208
(10 rows)

postgres=# select relname, relkind, relnatts, count(*) over(partition by relkind) as kind_cnt, sum(relnatts) over(order by relname) from pg_class limit 10;
              relname              | relkind | relnatts | kind_cnt | sum
-----------------------------------+---------+----------+----------+-----
 _pg_foreign_data_wrappers         | v       |        7 |      112 |   7
 _pg_foreign_servers               | v       |        9 |      112 |  16
 _pg_foreign_table_columns         | v       |        4 |      112 |  20
 _pg_foreign_tables                | v       |        7 |      112 |  27
 _pg_user_mappings                 | v       |        7 |      112 |  34
 administrable_role_authorizations | v       |        3 |      112 |  37
 applicable_roles                  | v       |        3 |      112 |  40
 attributes                        | v       |       31 |      112 |  71
 character_sets                    | v       |        8 |      112 |  79
 check_constraint_routine_usage    | v       |        6 |      112 |  85
(10 rows)

postgres=# select relname, relkind, relnatts, rank() over(order by relname) from pg_class limit 10;
              relname              | relkind | relnatts | rank
-----------------------------------+---------+----------+------
 _pg_foreign_data_wrappers         | v       |        7 |    1
 _pg_foreign_servers               | v       |        9 |    2
 _pg_foreign_table_columns         | v       |        4 |    3
 _pg_foreign_tables                | v       |        7 |    4
 _pg_user_mappings                 | v       |        7 |    5
 administrable_role_authorizations | v       |        3 |    6
 applicable_roles                  | v       |        3 |    7
 attributes                        | v       |       31 |    8
 character_sets                    | v       |        8 |    9
 check_constraint_routine_usage    | v       |        6 |   10
(10 rows)

postgres=#
```

#### 其他例子（重要）
```
--  注意4800这两行
SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;
 salary |  sum  
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)
```




```
select snap_ts, size, (size - lead(size) over(order by snap_ts desc)) as difference
  from 
    (
      select snap_ts, sum(size) as size
        from (
      select snap_id, snap_ts, datname, pg_size_pretty,
               case when pg_size_pretty ilike '%GB%' then to_number(pg_size_pretty, '9999999')*1024
                  when pg_size_pretty ilike '%MB%' then to_number(pg_size_pretty, '9999999')
                  when pg_size_pretty ilike '%KB%' then round(to_number(pg_size_pretty, '9999999')/1024)
                  else 0
               end as size
        from snap_pg_db_size) a
       group by snap_ts
       order by snap_ts desc
    ) t;
```