https://github.com/digoal/blog/blob/master/201704/20170410_03.md  
https://www.postgresql.org/docs/10/static/runtime-config-replication.html#guc-vacuum-defer-cleanup-age  

备库并不是没有写，复制进程一直在写。


### 1. 主库配置
#### 1.1 vacuum_defer_cleanup_age
设置主库垃圾回收的延迟，例如配置为1000，表示垃圾版本将延迟1000个事务再被回收。

### 2. 备库配置
#### 2.1 hot_standby_feedback
如果设置为ON，备库在执行QUERY时会通知主库，哪些版本需要被保留。

#### 2.2 max_standby_archive_delay， max_standby_streaming_delay
表示当备库的QUERY与恢复进程发生冲突时，恢复进程最长的等待时间，当恢复进程从被冲突堵塞开始等待时间超过以上设置时，会主动KILL与之发生冲突的QUERY，然后开始恢复，直到catch up，才允许QUERY与恢复进程再次发生冲突。

#### 相关配置参数
```
## postgresql.conf
archive_command
hot_standby

## pg_hba.conf
replication
archive_cleanup_command

## recovery.conf
standby_mode = 'on'
primary_conninfo = 'host=192.168.1.50 port=5432 user=foo password=foopass'
restore_command = 'cp /path/to/archive/%f %p'
archive_cleanup_command = 'pg_archivecleanup /path/to/archive %r'

```

#### 其他参数
- synchronous_commit :  on,remote_write, local和off  。命令返回"成功"指示给客户端之前，指定是否事务提交将等待WAL记录被写入到磁盘
    - on: 命令返回"成功"指示给客户端, wal已经写入磁盘。默认配置
    - off: 没有写入，最大延迟wal_writer_delay的3倍
    - remote_write: 事务将等待 直到当前同步备库的答复表明它已经收到事务的提交记录，并且写入到备用操作系统， 但是数据并不一定在备库中达到稳定存储
    - 如果设置synchronous_standby_names， 该参数控制是否事务提交将等待它的WAL记录被复制到备用服务器。 当设置on的时候， 提交将等待直到回复当前同步备库表明它已收到事务提交记录，并刷新到磁盘
    - 如果不设置synchronous_standby_names， 设置on, remote_write和local 提供相同的同步级别：事务提交只能等待本地刷新到磁盘。

#### 监控用系统表
+ pg_stat_replication
+ pg_replication_slots

#### 监控用函数
+ pg_current_xlog_location
+ pg_last_xlog_receive_location

